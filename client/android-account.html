<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Android Account Client</title>
  <!-- Include the Socket.IO library -->
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
</head>
<body>
<h1>Android Account</h1>
<button id="connect-emulator">Connect to Emulator</button>
<video class="video-player" id="remote-video" autoplay playsinline controls style="display: none;"></video>
<div>
  <input type="text" id="adbCommand" placeholder="Enter ADB command" />
  <button id="sendCommand">Send Command</button>
</div>
<pre id="log"></pre>

<script>
  const remoteVideoEl = document.querySelector('#remote-video');

  const connectionId = "SamsungGalaxyS25"; // ID of the emulator to connect to
  const androidEmulator = 'SamsungGalaxyS25'; // Unique ID for the emulator
  const signalingServer = 'ws://localhost:3000/signaling'; // Socket.IO server
  const socketOptions = {
    transportOptions: {
      polling: {
        extraHeaders: {
          Authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI1NWE3Y2EyMC1hYjQwLTRjYzctYTIyYi1hOTEwNTkwNTEwNTEiLCJhY2NvdW50TmFtZSI6IkFuZHJvaWQgQWRtaW4iLCJlbWFpbCI6ImFuZHJvaWRhZG1pbkBkYW1hcnUuY29tIiwicm9sZSI6IkFuZHJvaWRVc2VyIiwiYWNjb3VudElkIjoiYTRmY2JhZDItMmMwNy00NTU5LTk4ZjMtMTBhMmZlNmIxY2FhIiwic3ViUm9sZSI6IkFuZHJvaWRBZG1pbiIsImlhdCI6MTczNjEyNzU5OSwiZXhwIjoxNzY3NjYzNTk5fQ.PpqliBaPEfjND66BBCrhxq3-yQMcwIgikq5wiJfPrgs',
        }
      }
    }
  };
  const socket = io(signalingServer, socketOptions); // Initialize Socket.IO client

  const log = (message) => {
    document.getElementById("log").textContent += `${message}\n`;
  };
  let peerConfiguration = {
    iceServers:[
      {
        urls:[
          'stun:stun.l.google.com:19302',
          'stun:stun1.l.google.com:19302'
        ]
      }
    ]
  }
  let peerConnection; // The peerConnection that the two clients use to talk
  let remoteStream; // A var to hold the remote video stream

  const addDummyTrack = (pc) => {
    // Create a blank video track
    const canvas = document.createElement("canvas");
    canvas.width = 640;
    canvas.height = 480;

    const stream = canvas.captureStream(1); // Capture at 1 FPS
    const dummyTrack = stream.getVideoTracks()[0];

    console.log("Adding dummy video track to PeerConnection:", dummyTrack);
    pc.addTrack(dummyTrack, stream);
  };

  const createPeerConnection = ()=>{
    return new Promise(async(resolve, reject)=>{
      peerConnection = await new RTCPeerConnection(peerConfiguration);
      remoteStream = new MediaStream();
      remoteVideoEl.srcObject = remoteStream;
      addDummyTrack(peerConnection);
      const dataChannel = peerConnection.createDataChannel('adb-command');
      dataChannel.onopen = () => {
        console.log('Data channel has been opened');
      };

      document.getElementById('sendCommand').addEventListener('click', () => {
        const adbCommand = document.getElementById('adbCommand').value; // Get the input text
        if (adbCommand && dataChannel.readyState === 'open') {
          dataChannel.send(adbCommand);  // Send the command via the data channel
          console.log('Command sent:', adbCommand);
        }
      });

      peerConnection.addEventListener("signalingstatechange", (event) => {
        console.log(event);
        console.log(peerConnection.signalingState);
      });

      peerConnection.addEventListener('icecandidate', e => {
        if (e.candidate) {
          socket.emit('IceCandidate', {
            iceCandidate: e.candidate, clientId: androidEmulator, isEmulator: false
          });
        }
      });

      peerConnection.addEventListener('track', (event) => {
        console.log("Track event received:", event);
        console.log("Streams associated with the track:", event.streams);

        // Check if the event contains a video track
        if (event.streams[0] && event.streams[0].getVideoTracks().length > 0) {
          // Show the video player only when a video track is available
          remoteVideoEl.style.display = "block";
        }

        event.streams[0]?.getTracks().forEach((track) => {
          remoteStream.addTrack(track);
          console.log("Added track to remoteStream:", track);
        });
      });

      peerConnection.addEventListener('iceconnectionstatechange', () => {
        console.log("ICE Connection State:", peerConnection.iceConnectionState);
      });

      peerConnection.addEventListener('connectionstatechange', () => {
        console.log("PeerConnection State:", peerConnection.connectionState);
      });

      resolve();
    });
  };

  socket.on("connect", () => {
    log("Socket.IO connected.");
    document.getElementById("connect-emulator").addEventListener("click", async () => {
      await createPeerConnection();
      try {
        console.log("Creating offer...");
        const offer = await peerConnection.createOffer();
        console.log(offer);
        await peerConnection.setLocalDescription(offer);
        socket.emit('Offer', { deviceId: androidEmulator, sdp: offer.sdp }); // Send offer to signalingServer
      } catch (err) {
        console.log(err);
      }
    });
  });

  socket.on('Answer', async (sdp) => {
    console.log("answer sdp", sdp);
    await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: sdp.sdp }));
  });

  socket.on("disconnect", () => log("Socket.IO connection closed."));
  socket.on('IceCandidate', (candidate) => {
    console.log('Adding ICE candidate to android', candidate);
    if (candidate) {
      peerConnection.addIceCandidate(candidate.iceCandidate);
    }
  });
</script>
</body>
</html>
