<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>Android Emulator</title>
  <script src='https://cdn.socket.io/4.8.1/socket.io.min.js'
          integrity='sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+'
          crossorigin='anonymous'></script>
</head>
<body>
<h1>Android Emulator</h1>
<button id='start-streaming'>Start Streaming</button>
<!--<video class="video-player" id="local-video" autoplay playsinline controls></video>-->

<pre id='log'></pre>

<script>
  const androidEmulator = '1'; // Unique ID for the emulator
  const signalingServer = 'ws://localhost:3000/signaling'; // Socket.IO server
  const socketOptions = {
    transportOptions: {
      polling: {
        extraHeaders: {
          Authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIzIiwiZW1haWwiOiJlbXVsYXRvckFkbWluQGRhbWFydS5jb20iLCJyb2xlIjoiRW11bGF0b3JBZG1pbiIsImlhdCI6MTczNjM4NjE2NSwiZXhwIjoxNzY3OTIyMTY1fQ.qP3p1YVEae_Xz75xELWSUItB12IIzIuSpd6UfR7-cRc'
        }
      }
    }
  };
  const socket = io(signalingServer, socketOptions); // Connect to namespace
  // const localVideoEl = document.querySelector('#local-video');
const connections = []
  // A function to execute the ADB command

  let localStream; //a var to hold the local video stream
  let remoteStream; //a var to hold the remote video stream
  let peerConnection; //the peerConnection that the two clients use to talk

  let peerConfiguration = {
    iceServers:[
      {
        urls:[
          'stun:stun.l.google.com:19302',
          'stun:stun1.l.google.com:19302'
        ]
      }
    ]
  }

  const log = (message) => {
    document.getElementById('log').textContent += `${message}\n`;
  };
  const fetchUserMedia = ()=>{
    return new Promise(async(resolve, reject)=>{
      try{
        const displayMediaOptions = {
          video: {
            cursor: "always"
          },
          audio: false
        };
        const stream =   await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);
        // localVideoEl.srcObject = stream;
        localStream = stream;
        resolve();
      }catch(err){
        log(err);
        reject()
      }
    })
  }
  const createPeerConnection = (clientId)=>{
    return new Promise(async(resolve, reject)=>{
      //RTCPeerConnection is the thing that creates the connection
      //we can pass a config object, and that config object can contain stun servers
      //which will fetch us ICE candidates
      peerConnection = await new RTCPeerConnection(peerConfiguration)
      connections.push(peerConnection)
      remoteStream = new MediaStream()

      localStream.getVideoTracks().forEach(track=>{
        console.log("Adding track to PeerConnection:", track);
        //add local tracks so that they can be sent once the connection is established
        peerConnection.addTrack(track,localStream);
      })

      peerConnection.addEventListener("signalingstatechange", (event) => {
        console.log(event);
        console.log(peerConnection.signalingState)
      });

      peerConnection.addEventListener('icecandidate',e=>{
        console.log('........Ice candidate found!......')
        console.log(e)
        if(e.candidate){
          socket.emit('IceCandidate',{
            iceCandidate: e.candidate,
            clientId,
            deviceId: androidEmulator,
            isEmulator: true
          })
        }
      })
      peerConnection.addEventListener('iceconnectionstatechange', () => {
        console.log("ICE Connection State:", peerConnection.iceConnectionState);
      });

      peerConnection.addEventListener('connectionstatechange', () => {
        console.log("PeerConnection State:", peerConnection.connectionState);
      });
      peerConnection.ondatachannel = (event) => {
        const dataChannel = event.channel;
        dataChannel.onmessage = (event) => {
          socket.emit('RunCommand', {adbCmd: event.data })
          console.log('Received message from Peer 1:', event.data);
        };
      };

      resolve();
    })
  }

  socket.on('connect', () => {
    log('Socket.IO connected.');
    // Handle Start Streaming button
    document.getElementById('start-streaming').addEventListener('click', async () => {
      await fetchUserMedia();
      socket.emit('StartStreaming', { deviceId: androidEmulator})
    });
  });

  socket.on('Offer', async (message) => {
    const { clientId, sdp } = message;
    console.log(`Received offer from client: ${clientId}`);
    console.log(`Received offer from sdp: ${sdp}`);
    await createPeerConnection(clientId)

    // // Handle SDP offer and create an answer
    await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp }));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    //
    // // Send the answer back to the server
    socket.emit('Answer', { clientId, sdp: answer.sdp });
    console.log({ connections })
    console.log(`Sent answer to client: ${clientId}`);
  });

  socket.on('IceCandidate', (candidate) => {
    console.log('Adding ice candidate', candidate)
    if(candidate) {
      peerConnection.addIceCandidate(candidate.iceCandidate)
    }
  })

  socket.on('disconnect', () => log('Socket.IO connection closed.'));


</script>

</body>
</html>
